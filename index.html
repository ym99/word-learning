<!DOCTYPE html>
<html lang="en">
<head>
    <title>Word Learning v2.0</title>
    <meta charset="utf-8" />
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <style>
        body { 
            padding-top: 60px; 
        }

        #table th {
            text-align: center;
        }

        #table td {
            text-align: center;
        }

        #grade {
            font-size: large;
        }

        #final-grade {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%); 
            z-index: 1000;
            display: none;
            text-align:center;         
        }

        input.error {
            background-color: rgb(242, 222, 222);
            outline-color: darkred;
        }

    </style>
</head>
<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container-fluid">

            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-bar" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Word Learning</a>
            </div>

            <div class="navbar-text navbar-right">
                <span id="grade"></span>
                <span id="percent" class="badge"></span>
                <b><span id="new-words"></span></b> new and
                <b><span id="words"></span></b> known words
                &nbsp;
                &nbsp;
            </div>

            <div class="collapse navbar-collapse" id="nav-bar">
                <ul class="nav navbar-nav">
                    <li id="mode-new"><a href="#" onclick="runNew(); return false;">New Words Only</a></li>
                    <li id="mode-mix"><a href="#" onclick="runMix(); return false;">Mix of New and Old Words</a></li>
                    <li id="mode-test" class="active"><a href="#" onclick="runTest(); return false;">Test</a></li>
                </ul>
            </div>

        </div>
    </nav>

    <table id="table" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th class="col-md-3">Number</th>
                <th class="col-md-3">Question</th>
                <th class="col-md-3">Answer</th>
                <th class="col-md-3">Correct Answer</th>
            </tr>
        </thread>
        <tbody>
        </tbody>
    </table>

    <div id="final-grade"></div>

    <script src="words.js"></script>
    <script>
        function createQuestions(assignment) {

            function createSpanishQuestion(word) {
                return {
                    question: word.spanish + (word.spanishComment || ""),
                    answer: word.english,
                };
            }

            function createEnglishQuestion(word) {
                return {
                    question: word.english + (word.englishComment || ""),
                    answer: word.spanish,
                };
            }

            $("#new-words").text(assignment.newWords.length);
            $("#words").text(assignment.words.length);

            let questions = [];

            for (let i = 0; i < assignment.newWords.length; i++) {
                for (let c = 0; c < assignment.newWordsRatio; c++) {
                    questions.push(createSpanishQuestion(assignment.newWords[i]));
                    questions.push(createEnglishQuestion(assignment.newWords[i]));
                }
            }

            for (let i = 0; i < assignment.words.length; i++) {
                for (let c = 0; c < assignment.wordsRatio; c++) {
                    questions.push(createSpanishQuestion(assignment.words[i]));
                    questions.push(createEnglishQuestion(assignment.words[i]));
                }
            }

            return questions;
        }

        function showNextQuestion(questions) {
            if (questions.length === 0) {
                showFinalGrade();
                return;
            }

            const index = Math.floor(Math.random() * questions.length);
            var question = questions.splice(index, 1)[0];

            $tr = $("<tr></tr>").appendTo("#table tbody");

            $("<th scope='row'></th>").appendTo($tr).text(($("#percent").data("total") || 0) + 1);

            $("<td></td>").appendTo($tr).text(question.question);
            
            $("<td></td>")
                .appendTo($tr)
                .append("<input type='text'></input>")

                .find("input")
                .data("answer", question.answer)
                .focus()
                .bind("keydown", function (event) { return keyDown(event); })
                .bind("keypress", function (event) { return keyPress(event); })
            ;

            $("<td></td>")
                .appendTo($tr)
                .append("<button type='button' id='button'></button>")
                .find("button")
                .text("check")
                .bind("click", function (event) { checkInput(event, questions); })
            ;
        }

        function keyDown(event) {
            const e = event || window.event;
            
            $(e.target).removeClass("error");

            return true;
        }

        function keyPress(event) {
            const e = event || window.event;
            
            if (e.keyCode === 13) {
                $(e.target).closest("tr").find("button").click();
                return false;
            }
            return true;
        }

        function checkInput(event, questions) {
            function isEqual(x, y) {
                return x.trim().toUpperCase() === y.trim().toUpperCase();
            }

            const $button = $((event || window.event).target);
            const $input = $button.closest("tr").find("input");

            const answer = $input.val();
            if (answer.match(/[^ A-Za-z]/)){
                $input
                    .focus()
                    .select()
                    .addClass("error");
                return;
            }
            const correctAnswer = $input.data("answer");
            const isCorrect = isEqual(answer, correctAnswer);

            // on the table
            $input
                .closest("tr")
                .toggleClass("success", isCorrect)
                .toggleClass("danger", !isCorrect)
            ;

            $input.closest("td").text(answer);
            $button.closest("td").text(correctAnswer);

            $input.remove();
            $button.remove();

            // on the navbar
            const $percent = $("#percent");
            const correct = ($percent.data("correct") || 0) + (isCorrect ? 1 : 0);
            const total = ($percent.data("total") || 0) + 1;

            $percent
                .data("correct", correct)
                .data("total", total)
            ;

            const percent = correct / total;
            $percent.text((percent * 100).toFixed(0) + "% correct");

            $("#grade").html(
                percent >= 0.94 ? "<span class='label label-success'>A</span>" :
                percent >= 0.90 ? "<span class='label label-success'>A-</span>" :
                percent >= 0.87 ? "<span class='label label-info'>B+</span>" :
                percent >= 0.83 ? "<span class='label label-info'>B</span>" :
                percent >= 0.80 ? "<span class='label label-info'>B-</span>" :
                percent >= 0.77 ? "<span class='label label-warning'>C+</span>" :
                percent >= 0.73 ? "<span class='label label-warning'>C</span>" :
                percent >= 0.70 ? "<span class='label label-warning'>C-</span>" :
                percent >= 0.67 ? "<span class='label label-danger'>D+</span>" :
                percent >= 0.60 ? "<span class='label label-danger'>D</span>" :
                                  "<span class='label label-danger'>F</span>"
            );

            setTimeout(function () { showNextQuestion(questions); }, 0);
        }

        function showFinalGrade(){
            const $finalGrade  = $("#final-grade");
            $("#grade")
                .clone()
                .css("font-size", "1000%")
                .appendTo($finalGrade)
            ;
            
            $("<br />")
                .appendTo($finalGrade)
            ;
            $("<br />")
                .appendTo($finalGrade)
            ;

            $("#percent")
                .clone()
                .css("font-size", "200%")
                .appendTo($finalGrade)
            ;

            $finalGrade.show();
        }

        function run(ratio) {
            $("#table tbody").empty();
            $("#final-grade").empty().hide();

            $("#percent")
                .data("correct", 0)
                .data("total", 0)
                .text("")
            ;

            $("#grade").empty().removeClass();

            showNextQuestion(
                createQuestions({
                    newWordsRatio: ratio.newWordsRatio,
                    newWords: newWords,
                    wordsRatio: ratio.wordsRatio,
                    words: words
                }));
        }

        function runNew(){
            $("#mode-new").addClass("active");
            $("#mode-mix").removeClass("active");
            $("#mode-test").removeClass("active");

            run({
                newWordsRatio: 10,
                wordsRatio: 0
            });
        }

        function runMix(){
            $("#mode-new").removeClass("active");
            $("#mode-mix").addClass("active");
            $("#mode-test").removeClass("active");

            run({
                newWordsRatio: 5,
                wordsRatio: 1
            });
        }

        function runTest(){
            $("#mode-new").removeClass("active");
            $("#mode-mix").removeClass("active");
            $("#mode-test").addClass("active");

            run({
                newWordsRatio: 1,
                wordsRatio: 1
            });
        }

        runTest();

    </script>
</body>
</html>
