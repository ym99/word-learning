<!DOCTYPE html>
<html lang="en">
<head>
    <title>Word Learning v1.1</title>
    <meta charset="utf-8" />
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <style>
        tr {
            text-align: center;
        }
        tr:nth-child(even) {
            background-color:#f5f5f5;
        }

        th {
            width: 200px;
            background-color:#d4d7fb;
        }

        .correct {
            color: green;
        }

        .incorrect {
            color: red;
        }

        #info {
            position: fixed;
            left: 0px;
            bottom: 0px;
            border: solid 1px black;
            background-color: #ddd;
            text-align: center;
            padding: 10px;
        }

        #info:hover {
            border: dashed 1px black;
            color: transparent;
            background-color: transparent;
        }

        #info:hover #modes {
            color: initial;
            background-color: initial;
        }

        .test-mode::before {
            content: "Test mode";
            font-weight: bold;
        }

        .learning-mode::before {
            content: "Learning mode";
            font-weight: bold;
        }

        .a-class::before {
            content: "A ";
            font-size: large;
            color: green;
        }

        .a-m-class::before {
            content: "A- ";
            font-size: large;
            color: green;
        }

        .b-p-class::before {
            content: "B+ ";
            font-size: large;
            color: yellowgreen;
        }

        .b-class::before {
            content: "B ";
            font-size: large;
            color: yellowgreen;
        }

        .b-m-class::before {
            content: "B- ";
            font-size: large;
            color: yellowgreen;
        }

        .c-p-class::before {
            content: "C+ ";
            font-size: large;
            color: orange;
        }

        .c-class::before {
            content: "C ";
            font-size: large;
            color: orange;
        }

        .c-m-class::before {
            content: "C- ";
            font-size: large;
            color: orange;
        }

        .d-p-class::before {
            content: "D+ ";
            font-size: large;
            color: orangered;
        }

        .d-class::before {
            content: "D ";
            font-size: large;
            color: orangered;
        }

        .f-class::before {
            content: "F ";
            font-size: large;
            color: red;
        }
    </style>
</head>
<body>
    <table id="table">
        <tr>
            <th>Number</th>
            <th>Question</th>
            <th>Answer</th>
            <th>Correct Answer</th>
        </tr>
    </table>
    <div id="info">
        <div>
            <span id="newWords"></span> new words
        </div>
        <div>
            <span id="words"></span> known words
        </div>
        <hr />
        <div id="modes">
            <input type="radio" id="new" name="mode" checked="checked" onclick="run({newWordsCount: 10, wordsCount: 0})" />
            <label for="new">New</label>
            <input type="radio" id="mix" name="mode" onclick="run({newWordsCount: 5, wordsCount: 1})" />
            <label for="mix">Mix</label>
            <input type="radio" id="test" name="mode" onclick="run({newWordsCount: 1, wordsCount: 1})" />
            <label for="test">Test</label>
        </div>
        <hr />
        <div>
            <span id="grade"></span>
            <span id="percent" data-correct="0" data-total="0">?</span>
            <span>correct</span>
        </div>
    </div>

    <script src="words.js"></script>
    <script>
        function createQuestions(assignment) {

            function createSpanishQuestion(word) {
                return {
                    question: word.spanish + (word.spanishComment || ""),
                    answer: word.english,
                };
            }

            function createEnglishQuestion(word) {
                return {
                    question: word.english + (word.englishComment || ""),
                    answer: word.spanish,
                };
            }

            let questions = [];

            for (let i = 0; i < assignment.newWords.length; i++) {
                for (let c = 0; c < assignment.newWordsCount; c++) {
                    questions.push(createSpanishQuestion(assignment.newWords[i]));
                    questions.push(createEnglishQuestion(assignment.newWords[i]));
                }
            }

            for (let i = 0; i < assignment.words.length; i++) {
                for (let c = 0; c < assignment.wordsCount; c++) {
                    questions.push(createSpanishQuestion(assignment.words[i]));
                    questions.push(createEnglishQuestion(assignment.words[i]));
                }
            }

            return questions;
        }

        function showNextQuestion(questions) {
            if (questions.length === 0) {
                return;
            }

            const index = Math.floor(Math.random() * questions.length);
            var question = questions.splice(index, 1)[0];

            const percent = document.getElementById("percent");
            const table = document.getElementById("table");

            const tr = document.createElement("tr");
            table.appendChild(tr);

            const countTd = document.createElement("td");
            tr.appendChild(countTd);
            countTd.appendChild(document.createTextNode(parseInt(percent.getAttribute("data-total")) + 1));

            const questionTd = document.createElement("td");
            tr.appendChild(questionTd);
            questionTd.appendChild(document.createTextNode(question.question));

            const answerTd = document.createElement("td");
            tr.appendChild(answerTd);
            const input = document.createElement("input");
            answerTd.appendChild(input);
            input.setAttribute("type", "text");
            input.setAttribute("id", "input");
            input.onkeypress = function (event) { return keyPress(event); };
            input.setAttribute("data-answer", question.answer);
            input.focus();

            const checkTd = document.createElement("td");
            tr.appendChild(checkTd);
            const button = document.createElement("button");
            checkTd.appendChild(button);
            button.setAttribute("type", "button");
            button.setAttribute("id", "button");
            button.onclick = function () { checkInput(questions); };
            button.appendChild(document.createTextNode("check"));
        }

        function keyPress(event) {
            if ((event || window.event).keyCode === 13) {
                document.getElementById('button').click();
                return false;
            }
            return true;
        }

        function isEqual(x, y) {
            return x.trim().toUpperCase() === y.trim().toUpperCase();
        }

        function checkInput(questions) {
            const input = document.getElementById("input");
            const answer = input.value;
            const correctAnswer = input.getAttribute("data-answer");

            const button = document.getElementById("button");

            input.parentElement.appendChild(document.createTextNode(answer));
            button.parentElement.appendChild(document.createTextNode(correctAnswer));

            const isCorrect = isEqual(answer, correctAnswer);
            input.parentElement.parentElement.className += isCorrect ? "correct" : "incorrect";
            registerAnswer(isCorrect);

            input.parentElement.removeChild(input);
            button.parentElement.removeChild(button);

            setTimeout(function () { showNextQuestion(questions); }, 0);
        }

        function resetAnswer(isCorrect) {
            const percent = document.getElementById("percent");

            percent.setAttribute("data-correct", "0");
            percent.setAttribute("data-total", "0");

            percent.innerHTML = "?";
            document.getElementById("grade").className = "";

        }

        function registerAnswer(isCorrect) {
            const percent = document.getElementById("percent");
            const correct = parseInt(percent.getAttribute("data-correct")) + (isCorrect ? 1 : 0);
            const total = parseInt(percent.getAttribute("data-total")) + 1;

            percent.setAttribute("data-correct", correct.toString());
            percent.setAttribute("data-total", total.toString());

            const value = correct / total;
            percent.innerHTML = (value * 100).toFixed(0) + "%";

            showGrade(value);
        }

        function showGrade(percent) {
            const gradeClass =
            percent >= 0.94 ? "a-class" :
            percent >= 0.90 ? "a-m-class" :
            percent >= 0.87 ? "b-p-class" :
            percent >= 0.83 ? "b-class" :
            percent >= 0.80 ? "b-m-class" :
            percent >= 0.77 ? "c-p-class" :
            percent >= 0.73 ? "c-class" :
            percent >= 0.70 ? "c-m-class" :
            percent >= 0.67 ? "d-p-class" :
            percent >= 0.60 ? "d-class" :
                              "f-class"
            ;

            document.getElementById("grade").className = gradeClass;
        }

        function showInfo(assignment) {
            const mode = document.getElementById("mode");
            const newWords = document.getElementById("newWords");
            const words = document.getElementById("words");
            
            newWords.innerHTML = assignment.newWords.length;
            words.innerHTML = assignment.words.length;

            return assignment;
        }

        function run(counts) {
            for (const table = document.getElementById("table") ; table.rows.length > 1;)
            {
                table.deleteRow(-1);
            }
            resetAnswer();

            showNextQuestion(
                createQuestions(
                    showInfo({
                        newWordsCount: counts.newWordsCount,
                        newWords,
                        wordsCount: counts.wordsCount,
                        words
                    })));
        }

        run({
            newWordsCount: 10,
            wordsCount: 0
        })
    </script>
</body>
</html>
